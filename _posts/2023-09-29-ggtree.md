---
layout: single
author_profile: true
title: How to make publishable phylogenies with ggree
subtitle: There's lots to learn!
gh-repo: amycjack/ggtree_scipts
gh-badge: [star, fork, follow]
tags: [R, tutorial, ggtree]
comments: true
---

{: .box-success}
Changing tip names and node numbers is a common difficulty when it comes to ggtree. Here is a simple tutorial to creating a pretty figure for your papers.

**The datasets used for this tutorial are found in my  [ggtree repo](https://github.com/amycjack/ggtree_scripts).**

## Here is a secondary heading


Read in the required R packages.

```R
library(ggtree)    # For tree visualization
library(ape)       # For phylogenetic data
library(tidytree)  # For working with tree data
library(treeio)    # For reading tree files
library(ggplot2)   # For plotting
library(tidyverse) # For data manipulation
library(scales)    # For scale adjustments
library(data.table) # For working with data tables
library(glue)      # For text formatting
```

Read in your tree. ```ggtree``` can read in a number of different tree formats. Here I am using a Newick tree format.
```R
# Read the phylogenetic tree data from a file
tree <- read.tree("descurainia_tree.tree")
```

## Bootstraps
Often our tree files will contain information at the internal nodes, such as bootstrap values. We need to create a dataframe of this information the tree file. I've rounded these values to 2 decimal places and filtered those values less than 60%.

```R
# Round tree internal labels (support values) to 2 decimal places
q <- ggtree(tree)
bootstraps <- q$data
bootstraps <- bootstraps[!bootstraps$isTip,]  # Filter out tip labels
bootstraps$label <- as.numeric(bootstraps$label)
bootstraps$label <- signif(bootstraps$label, digits = 2)
bootstraps <- bootstraps[bootstraps$label > 60,]  # Filter by a threshold
```
```R
> bootstraps
# A tibble: 16 × 9
   parent  node branch.length label isTip         x     y    branch angle
    <int> <int>         <dbl> <dbl> <lgl>     <dbl> <dbl>     <dbl> <dbl>
 1     NA    NA     NA           NA NA    NA        NA    NA         NA  
 2     21    22      0.000862   100 FALSE  0.000862  5.88  0.000431 106. 
 3     22    23      0.00755    100 FALSE  0.00841   9.75  0.00464  176. 
 4     23    24      0.00116    100 FALSE  0.00958   5.09  0.00900   91.7
 5     24    25      0.00144    100 FALSE  0.0110    6.69  0.0103   120. 
 6     26    27      0.000489    96 FALSE  0.0118    8.75  0.0116   158. 
 7     27    28      0.00189    100 FALSE  0.0137    9.5   0.0128   171  
 8     25    29      0.00243    100 FALSE  0.0134    5.5   0.0122    99  
 9     24    30      0.00350    100 FALSE  0.0131    3.5   0.0113    63  
10     23    31      0.00121    100 FALSE  0.00963  14.4   0.00902  259. 
11     31    32      0.00307    100 FALSE  0.0127   12.5   0.0112   225  
12     32    33      0.000968   100 FALSE  0.0137   11.5   0.0132   207  
13     32    34      0.000476    91 FALSE  0.0132   13.5   0.0129   243  
14     31    35      0.00431    100 FALSE  0.0139   16.3   0.0118   294. 
15     35    36      0.000173    83 FALSE  0.0141   17.6   0.0140   317. 
16     38    39      0.000149   100 FALSE  0.0144   19.5   0.0143   351
```

## Tree annotation
Read in a table containing information you want to annotate the tree with. My table contains the label IDs, species names, sample origin, and clade labels.

```R
# Read annotation data from a CSV file
data <- read.csv("tree_anno.csv", header = TRUE)
```
```
> data
      label     species         genus      family id       Origin clade
1   art_B82 Descurainia artemisioides Brassicacae  1 Gran Canaria     A
2   art_B83 Descurainia artemisioides Brassicacae  2 Gran Canaria     A
3  bour_563 Descurainia    bourgaeana Brassicacae  3     Tenerife     B
4   bour_GH Descurainia    bourgaeana Brassicacae  4     Tenerife     B
5  bour_51v Descurainia    bourgaeana Brassicacae  5     Tenerife     B
6   lem_98a Descurainia    bourgaeana Brassicacae  6     Tenerife     B
7   lem_98b Descurainia    bourgaeana Brassicacae  7     Tenerife     B
8  gil_131a Descurainia         gilva Brassicacae  8     La Palma     B
9  gil_B163 Descurainia         gilva Brassicacae  9     La Palma     B
10  gon_GHA Descurainia    gonzalezii Brassicacae 10     Tenerife     B
11 gon_B162 Descurainia    gonzalezii Brassicacae 11     Tenerife     B
12 lem_B157 Descurainia        lemsii Brassicacae 12     Tenerife     B
13  mil_GHA Descurainia    millefolia Brassicacae 13     Tenerife     A
14 mil_125a Descurainia    millefolia Brassicacae 14     La Palma     A
15 mil_128b Descurainia    millefolia Brassicacae 15     La Palma     A
16  mil_94v Descurainia    millefolia Brassicacae 16     Tenerife     A
17 pre_B120 Descurainia    preauxiana Brassicacae 17 Gran Canaria     A
18  pre_GHA Descurainia    preauxiana Brassicacae 18 Gran Canaria     A
19   tan_C6 Descurainia tanacetifolia Brassicacae 19     Outgroup     C
20  dep_C26 Descurainia      depressa Brassicacae 20     Outgroup     D
```
We often need to change the tip names with more readable species names. Here I've italised the species names. 

```R
# Add formatted columns to the annotation data
data <- dplyr::mutate(data, 
                      lab = glue("italic({species})~italic({genus})"),
                      color = c("#E495A5"),
                      name = glue("<i style='color:{color}'>{genus} **{species}**</i>")
)
```

## Highlighting clades
To highight each clade with alternating grey colours. In ```gtree```, the ```MRCA``` (Most Recent Common Ancestor) function is used to find and identify the most recent common ancestor node in a phylogenetic tree. Here we use to identify the clades for highlighting and add this information to our annotation data.
```R
# Group annotation data by clade and calculate the most recent common ancestor (MRCA) node
clades.df <- data %>%
  group_by(clade) %>%
  summarise(node = MRCA(tree, data$label[data$clade == clade])) %>%
  distinct() %>%
  ungroup()
```
The dataframe now contains the clade information from our _data_ table and their node numbers.
```R
> clades.df
# A tibble: 4 × 2
  clade  node
  <chr> <int>
1 A        24
2 B        31
3 C        19
4 D        20
```
To create alternating colours for the clades, we need to add 0 or 1 to the table.
```
# Define alternating gray colors
gray_colors <- c("white", "gray")
clades.df$color_group <- factor(clades.df$node %% 2, levels = 0:1)
```

```R
> clades.df
# A tibble: 4 × 3
  clade  node color_group
  <chr> <int> <fct>      
1 A        24 0          
2 B        31 1          
3 C        19 1          
4 D        20 0
```

## Plotting
Create you plot

```R
# Plot the phylogenetic tree with annotations
ggtree(tree, ladderize = TRUE, size = 0.5) %<+% data +
  geom_tiplab(aes(label = lab), parse = T, hjust = -0.05, align = TRUE, linesize = 0.5) +
  geom_tippoint(aes(colour = Origin, shape = Origin), size = 4, show.legend = TRUE) +
  geom_text2(data = bootstraps, aes(label = label), hjust = -0.3, size = 2.5) +
  geom_treescale(x = 0.02, y = 0.01, offset = 0.1, offset.label = -0.2, label = "substitution rate") +
  geom_highlight(data = clades.df, 
                 aes(node = node, fill = color_group, group = clade),
                 alpha = 0.1,
                 align = "right",
                 extend = 0.005,
                 show.legend = FALSE) +
  geom_cladelab(data = clades.df,
                mapping = aes(node = node, label = clade),
                fontsize = 2,
                align = TRUE,
                offset = 0.005,
                offset.text = 0.00005,
                show.legend = FALSE) +
  scale_fill_manual(values = gray_colors)  # Set the fill colors for alternating clades
```

